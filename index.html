<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Документация</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Montserrat:wght@600&display=swap" rel="stylesheet">
</head>
<body>
<div class="container">
    <!-- Меню слева -->
    <nav class="sidebar">
        <button onclick="showContent('intro')">Введение</button>
        <button onclick="showContent('architecture')">Архитектура</button>
        <button onclick="showContent('infrastructure')">Инфраструктурные решения</button>
        <button onclick="showContent('install')">Установка</button>
        <button onclick="showContent('algorithm')">Алгоритм</button>
        <button onclick="showContent('usage')">Использование</button>
        <button onclick="showContent('sbComputer')">Работа с одноплатным компьютером</button>
    </nav>

    <!-- Контент справа -->
    <main class="content">
        <div id="intro" class="content-section">
            <h1>Введение</h1>
            <p>Данный сервис представляет собой цифрового ассистента для врачей родильных отделений разработанный командой BroCode в рамках хакатона ЛЦТ 2025, направленного на
                автоматизацию мониторинга и анализа данных с фетальных мониторов. Основная цель — облегчить
                интерпретацию сложных медицинских сигналов и визуализировать динамику в наглядной форме, что позволяет
                медицинскому персоналу быстрее и точнее принимать решения в условиях повышенной нагрузки.</p>

            <p>В отличие от методов машинного обучения, в нашем решении применяются алгоритмы детерминированного анализа
                и распознавания ключевых паттернов в реальном времени. Система обрабатывает потоковые и архивированные
                данные, выявляя важные параметры, такие как децелерации, тахикардия, брадикардия и вариабельность
                сердечного ритма, а также строит краткосрочные прогнозы на основе текущих и исторических данных.</p>
        </div>

        <div id="architecture" class="content-section">
            <h1>Архитектура</h1>
            <img src="images/architecture.png" alt="arch" style="max-width: 100%; height: auto;">
            <h2>Проект состоит из трех основных компонентов:</h2>

            <h2>Сервис patient-history (Spring Boot)</h2>
            <ul>
                <li>Хранит данные пациенток, поступающие с медицинских приборов: показатели матки (uterus) и частоту
                    сердечных сокращений плода (bpm) во время родов.
                </li>
                <li>Взаимодействие с пользователем происходит через встроенный Thymeleaf.</li>
                <li>Сервис способен запускать поток данных через WebSocket, имитируя работу медицинских приборов в
                    реальном времени.
                </li>
            </ul>

            <h2>Сервис device (Spring Boot)</h2>
            <ul>
                <li>Читает данные с WebSocket сервиса patient-history.</li>
                <li>Обрабатывает и анализирует данные, выделяя необходимые параметры.</li>
                <li>Передает обработанные данные через свой WebSocket.</li>
            </ul>

            <h2>Фронтенд-приложение</h2>
            <ul>
                <li>Периодически обращается к REST API сервиса device для получения данных о пациенте.</li>
                <li>Подписывается на WebSocket сервиса device для получения данных в реальном времени.</li>
                <li>Отображает графики и визуализации данных для удобства врачей.</li>
            </ul>

            <p>Взаимодействие между сервисами основано на REST и WebSocket, обеспечивая обработку и визуализацию данных
                в режиме реального времени. База данных хранит историю данных, что позволяет проводить анализ и
                мониторинг динамики состояний пациенток.</p>
            <p>Основная причина использование WebSocket для потоковой передачи данных: скорость и простота применения, в
                сравнении с различными брокерами сообщений.</p>
        </div>

        <div id="infrastructure" class="content-section">
            <h1>Инфраструктурные решения</h1>
            <img src="images/infra.png" alt="infra" style="max-width: 100%; height: auto;">
            <p>Проект развернут в Kubernetes-кластере из двух нод — одна мастер-нодa и одна воркер-нодa. Такой подход
                обеспечивает баланс между простотой поддержки и отказоустойчивостью, что важно для стабильной работы
                медицинского сервиса в режиме 24/7.</p>
            <h2>Управление кластером</h2>
            <ul>
                <li>Для управления кластером используется Argo CD</li>
                <li>Автоматизация процесса доставки кода (Continuous Delivery)</li>
                <li>Централизованный просмотр логов</li>
                <li>Визуальный контроль состояния сервисов в кластере</li>
            </ul>
            <h2>Безопасность</h2>
            <ul>
                <li>Для управления сертификатами применён cert-manager</li>
                <li>Автоматическое создание и обновление TLS-сертификатов</li>
                <li>Упрощение безопасности сетевого взаимодействия</li>
            </ul>
            <h2>CI/CD процесс</h2>
            <ul>
                <li>Исходный код хранится в GitHub</li>
                <li>При пуше в ветку master автоматически запускаются GitHub Actions</li>
                <li>Последовательное выполнение сборки, тестирования и деплоя приложений</li>
                <li>Создание контейнера при успешном билде и тестах</li>
                <li>Сохранение контейнера в GitHub Container Registry</li>
            </ul>
            <h2>Автоматизация деплоя</h2>
            <ul>
                <li>Инфраструктурный репозиторий синхронизирован с Argo CD</li>
                <li>Отслеживание тегов контейнеров</li>
                <li>Автоматический деплой нового контейнера в продакшен при обнаружении нового тега</li>
                <li>Обеспечение непрерывного обновления приложения</li>
            </ul>
        </div>

        <div id="install" class="content-section hidden">
            <h1>Установка</h1>
            <p>Шаги по установке...</p>
            <img src="images/install.png" alt="Install">
        </div>
        <div id="usage" class="content-section hidden">
            <h1>Использование</h1>
            <p>Пример использования...</p>
        </div>

        <div id="algorithm" class="content-section hidden">
            <h1>Алгоритм обработки данных для оценки рисков гипоксии плода</h1>

            <a href="https://github.com/Dan9191/device/blob/master/src/main/java/dan/competition/device/service/MessageHandlerService.java" target="_blank">Сервис, занимающийся потоковой обработкой данных</a>


            <p>Эта документация описывает ключевые шаги алгоритма в сервисе <code>MessageHandlerService</code>. Алгоритм
                работает в реальном времени: получает данные о пациенте и медицинские показатели, анализирует их по
                временным интервалам, проверяет риски осложнений и формирует предсказания. Для простоты фокус на
                основных этапах без технических деталей реализации (например, WebSocket или логирования).</p>
            <p>Алгоритм разделен на 4 части, как указано в запросе.</p>

            <h2>1. Подготовительная часть</h2>
            <p>На этом этапе обрабатываются начальные данные о пациенте, полученные через WebSocket (<code>PatientDataWebSocket</code>).
                Цель — установить персонализированные нормы и базовый риск рождения ребенка с гипоксией на основе
                диагнозов пациента.</p>
            <ul>
                <li><strong>Шаги обработки</strong>:
                    <ol>
                        <li>Получение данных: ID пациента, имя, возраст, биохимические показатели (pH, CO2, Glu, Lac,
                            BE) и список диагнозов (<code>DiagnosisDTO</code>).
                        </li>
                        <li>Проверка на нового пациента: Если ID изменился, сбрасываются все накопленные данные (средние
                            значения, счетчики рисков, временные окна).
                        </li>
                        <li>Применение диагнозов: Для каждого диагноза в списке проверяется поле <code>impact</code> —
                            это Groovy-скрипт, который модифицирует стартовые переменные.
                            <ul>
                                <li>Скрипт ничего не возвращает (void), но изменяет нормы (например, min/max для BPM и
                                    Uterus) и базовый риск (<code>riskComplications</code>).
                                </li>
                                <li>Пример скрипта в <code>impact</code>: <code>bpmMin = 100.0; bpmMax = 150.0;
                                    riskComplications = 10.0;</code> (снижает нижнюю норму BPM и добавляет 10% базового
                                    риска).
                                </li>
                                <li>Если <code>impact</code> пустой или содержит "нет влияния" — пропускается.</li>
                            </ul>
                        </li>
                        <li>Сохранение данных: Обновленные переменные (в карте <code>avgVariables</code>) используются
                            для дальнейшего анализа. Базовый риск (<code>riskComplications</code>) теперь отражает
                            влияние всех диагнозов.
                        </li>
                    </ol>
                </li>
                <li><strong>Результат</strong>: Установлены индивидуальные нормы и стартовый (базовый) риск гипоксии (от
                    0% до 100%). Это основа для динамического расчета рисков в последующих этапах.
                </li>
            </ul>

            <h2>2. Сбор данных в пачки для вычисления средних показателей</h2>
            <p>Медицинские данные (<code>MedicalDataWebSocket</code>) поступают в реальном времени: время в секундах
                (<code>timeSec</code>), сократительная активность матки (<code>uterus</code>) и частота сердечных
                сокращений плода (<code>bpm</code>).</p>
            <ul>
                <li><strong>Шаги обработки</strong>:
                    <ol>
                        <li>Определение временного интервала (пачки): Данные группируются в окна по 10 секунд (индекс
                            окна = <code>timeSec / 10.0</code>). Это позволяет вычислять средние значения без перегрузки
                            системы.
                        </li>
                        <li>Накопление значений: Валидные данные (BPM > 0, Uterus > 0) добавляются в списки (<code>bpmWindow</code>
                            и <code>uterusWindow</code>) для текущего окна.
                        </li>
                        <li>Переход к новому окну: Если индекс окна изменился, предыдущее окно закрывается, и
                            вычисляются средние:
                            <ul>
                                <li><code>avgBpm</code> и <code>avgUterus</code> — средние за текущее окно.</li>
                                <li><code>prevAvgBpm</code> и <code>prevAvgUterus</code> — сохраняются из предыдущего.
                                </li>
                                <li><code>fullAvgBpm</code> и <code>fullAvgUterus</code> — накопленные средние за весь
                                    сеанс (взвешенные по количеству окон).
                                </li>
                            </ul>
                        </li>
                        <li>Счетчик окон: Увеличивается на 1 после каждого закрытия.</li>
                    </ol>
                </li>
                <li><strong>Результат</strong>: Подготовлены средние показатели для анализа рисков. Это обеспечивает
                    плавный мониторинг изменений во времени, без учета единичных выбросов.
                </li>
            </ul>

            <h2>3. Проверка осложнений в конце каждого промежутка</h2>
            <p>После закрытия окна запускается анализ рисков на основе списка осложнений (<code>Complications</code>).
                Каждое осложнение имеет поле <code>condition</code> — Groovy-скрипт, который проверяет наличие риска по
                текущим средним значениям.</p>
            <ul>
                <li><strong>Шаги обработки</strong>:
                    <ol>
                        <li>Перебор осложнений: Для каждого объекта <code>Complications</code> выполняется скрипт в
                            <code>condition</code>.
                            <ul>
                                <li>Скрипт возвращает boolean: true (риск есть) или false (риска нет).</li>
                                <li>Скрипт использует переменные из <code>avgVariables</code> (например,
                                    <code>avgBpm</code>, <code>bpmMin</code>, <code>bpmMax</code> и т.д.).
                                </li>
                                <li>Пример объекта <code>Complications</code>:
                                    <pre>
new Complications(3L,
    "Брадикардия",
    "Замедление частоты сердечных сокращений",
    "avgBpm < bpmMin"
)
                            </pre>
                                    <ul>
                                        <li>Если <code>avgBpm</code> ниже нормы (<code>bpmMin</code>), скрипт вернет
                                            true.
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li>Обновление счетчиков рисков: Для каждого осложнения ведется отдельный счетчик (в мапе <code>riskCounters</code>,
                            ключ — ID осложнения).
                            <ul>
                                <li>Если риск = true: счетчик +1 (риск накапливается при повторении).</li>
                                <li>Если риск = false: счетчик -2 (риск быстро снижается при нормализации), но не ниже
                                    0.
                                </li>
                            </ul>
                        </li>
                        <li>Влияние на общий риск: Каждый активный счетчик (>0) прибавляет к динамическому риску
                            гипоксии. Суммарный счетчик всех осложнений (total) умножается на 5% для динамической части
                            риска.
                        </li>
                    </ol>
                </li>
                <li><strong>Результат</strong>: Обновлены счетчики для каждого осложнения. Это моделирует "память"
                    системы: повторяющиеся риски усиливают общий шанс гипоксии, а исчезающие — снижают его.
                </li>
            </ul>

            <h2>4. Формирование предсказания с перечислением осложнений и шансом гипоксии</h2>
            <p>После анализа создается объект <code>Prediction</code> и отправляется по WebSocket (<code>/topic/predictions</code>).
            </p>
            <ul>
                <li><strong>Шаги обработки</strong>:
                    <ol>
                        <li>Сбор активных осложнений: Список имен осложнений, где счетчик > 0.</li>
                        <li>Формирование сообщения (<code>message</code>):
                            <ul>
                                <li>Если активных нет: "Прогноз положительный".</li>
                                <li>Если есть: "Активные осложнения: [имя1, имя2, ...]".</li>
                            </ul>
                        </li>
                        <li>Определение уровня серьезности (<code>severity</code>):
                            <ul>
                                <li>Суммарный счетчик (total) всех осложнений:
                                    <ul>
                                        <li>>6: "negative" (высокий риск).</li>
                                        <li>=0: "positive" (низкий риск).</li>
                                        <li>Иначе: "normal" (средний риск).</li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li>Расчет шанса гипоксии (<code>riskComplication</code>):
                            <ul>
                                <li>Базовый риск (из части 1, <code>riskComplications</code>).</li>
                                <li>Динамический риск: total * 5% (ограничено до 100%).</li>
                                <li>Итоговый шанс: базовый + динамический (ограничено 0–100%).</li>
                            </ul>
                        </li>
                        <li>Добавление времени: <code>timestamp</code> = текущее время.</li>
                    </ol>
                </li>
                <li><strong>Результат</strong>: Готовое предсказание с текстом, уровнем серьезности и шансом родов с
                    гипоксией. Это позволяет пользователю (врачу) быстро оценить ситуацию и принять меры.
                </li>
            </ul>
        </div>

        <div id="sbComputer" class="content-section hidden">
            <h1>Работа с одноплатным компьютером</h1>
            <p>Пример использования...</p>
            <img src="images/usage.png" alt="Usage">
        </div>
    </main>
</div>
<script src="script.js"></script>
</body>
</html>